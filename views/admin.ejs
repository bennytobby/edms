<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - EDMS</title>
    <link rel="stylesheet" href="/styles/main.css" />
  </head>
  <body>
    <header class="topbar">
      <h2>EDMS Admin Dashboard</h2>
      <div class="user-info">
        Welcome, <strong><%= user.firstname %></strong>
        <span class="user-role role-<%= user.role %>"><%= user.role %></span> |
        <a href="/dashboard" class="logout-btn">Back to Dashboard</a> |
        <a href="/logout" class="logout-btn">Logout</a>
      </div>
    </header>

    <main class="container">
      <div class="admin-header">
        <h1>User Management</h1>
        <p>Manage user accounts, roles, and permissions</p>
      </div>

      <div class="admin-stats">
        <div class="stat-card">
          <h3><%= users.length %></h3>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <h3><%= users.filter(u => u.role === 'admin').length %></h3>
          <p>Admins</p>
        </div>
        <div class="stat-card">
          <h3><%= users.filter(u => u.role === 'contributor').length %></h3>
          <p>Contributors</p>
        </div>
        <div class="stat-card">
          <h3><%= users.filter(u => u.role === 'viewer').length %></h3>
          <p>Viewers</p>
        </div>
      </div>

      <section class="users-section">
        <div class="section-header">
          <h2>All Users</h2>
          <div class="search-controls">
            <input type="text" id="userSearch" placeholder="Search users..." class="search-input">
            <select id="roleFilter" class="filter-select">
              <option value="">All Roles</option>
              <option value="admin">Admins</option>
              <option value="contributor">Contributors</option>
              <option value="viewer">Viewers</option>
            </select>
          </div>
        </div>

        <div class="users-grid">
          <% users.forEach(user => { %>
          <div class="user-card" data-user-id="<%= user.userid %>" data-role="<%= user.role %>">
            <div class="user-header">
              <div class="user-avatar">
                <%= user.firstname.charAt(0).toUpperCase() %><%= user.lastname.charAt(0).toUpperCase() %>
              </div>
              <div class="user-info">
                <h3><%= user.firstname %> <%= user.lastname %></h3>
                <p class="user-email"><%= user.email %></p>
                <p class="user-id">ID: <%= user.userid %></p>
              </div>
            </div>

            <div class="user-details">
              <div class="user-meta">
                <div class="meta-item">
                  <strong>Role:</strong>
                  <span class="user-role role-<%= user.role %>"><%= user.role %></span>
                </div>
                <div class="meta-item">
                  <strong>Joined:</strong>
                  <%= new Date(user.createdAt).toLocaleDateString() %>
                </div>
                <% if (user.phone) { %>
                <div class="meta-item">
                  <strong>Phone:</strong>
                  <%= user.phone %>
                </div>
                <% } %>
              </div>
            </div>

            <div class="user-actions">
              <div class="role-controls">
                <label for="role-<%= user.userid %>">Change Role:</label>
                <select id="role-<%= user.userid %>" class="role-select" data-user-id="<%= user.userid %>">
                  <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Admin</option>
                  <option value="contributor" <%= user.role === 'contributor' ? 'selected' : '' %>>Contributor</option>
                  <option value="viewer" <%= user.role === 'viewer' ? 'selected' : '' %>>Viewer</option>
                </select>
                <button class="button primary small update-role-btn" data-user-id="<%= user.userid %>">
                  Update
                </button>
              </div>

              <div class="action-buttons">
                <% if (user.userid !== user.userid) { %>
                <button class="button secondary small revoke-btn" data-user-id="<%= user.userid %>">
                  Revoke Access
                </button>
                <button class="button danger small delete-btn" data-user-id="<%= user.userid %>">
                  Delete User
                </button>
                <% } else { %>
                <span class="current-user-badge">Current User</span>
                <% } %>
              </div>
            </div>
          </div>
          <% }); %>
        </div>
      </section>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">Confirm Action</h3>
        <p id="modalMessage">Are you sure you want to perform this action?</p>
        <div class="modal-actions">
          <button id="confirmBtn" class="button danger">Confirm</button>
          <button id="cancelBtn" class="button secondary">Cancel</button>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; <%= new Date().getFullYear() %> Paramraj Singh Machre</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
      // Admin Dashboard JavaScript
      document.addEventListener('DOMContentLoaded', function() {
        initAdminDashboard();
      });

      function initAdminDashboard() {
        // Search functionality
        const searchInput = document.getElementById('userSearch');
        const roleFilter = document.getElementById('roleFilter');

        searchInput.addEventListener('input', filterUsers);
        roleFilter.addEventListener('change', filterUsers);

        // Role update functionality
        document.querySelectorAll('.update-role-btn').forEach(btn => {
          btn.addEventListener('click', updateUserRole);
        });

        // Revoke access functionality
        document.querySelectorAll('.revoke-btn').forEach(btn => {
          btn.addEventListener('click', revokeUserAccess);
        });

        // Delete user functionality
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', deleteUser);
        });
      }

      function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const roleFilter = document.getElementById('roleFilter').value;
        const userCards = document.querySelectorAll('.user-card');

        userCards.forEach(card => {
          const userName = card.querySelector('h3').textContent.toLowerCase();
          const userEmail = card.querySelector('.user-email').textContent.toLowerCase();
          const userRole = card.dataset.role;

          const matchesSearch = userName.includes(searchTerm) || userEmail.includes(searchTerm);
          const matchesRole = !roleFilter || userRole === roleFilter;

          if (matchesSearch && matchesRole) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      async function updateUserRole(event) {
        const userId = event.target.dataset.userId;
        const roleSelect = document.getElementById(`role-${userId}`);
        const newRole = roleSelect.value;

        try {
          const response = await fetch('/api/update-user-role', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: userId,
              newRole: newRole
            })
          });

          const result = await response.json();

          if (response.ok) {
            showNotification('User role updated successfully!', 'success');
            // Update the role display
            const userCard = document.querySelector(`[data-user-id="${userId}"]`);
            const roleSpan = userCard.querySelector('.user-role');
            roleSpan.textContent = newRole;
            roleSpan.className = `user-role role-${newRole}`;
            userCard.dataset.role = newRole;
          } else {
            showNotification('Error: ' + result.error, 'error');
          }
        } catch (error) {
          showNotification('Error updating user role: ' + error.message, 'error');
        }
      }

      function revokeUserAccess(event) {
        const userId = event.target.dataset.userId;
        showConfirmModal(
          'Revoke User Access',
          'Are you sure you want to revoke this user\'s access? They will be downgraded to viewer role.',
          () => performRevokeAccess(userId)
        );
      }

      function deleteUser(event) {
        const userId = event.target.dataset.userId;
        showConfirmModal(
          'Delete User',
          'Are you sure you want to delete this user? This will permanently delete their account and all their files. This action cannot be undone.',
          () => performDeleteUser(userId)
        );
      }

      function showConfirmModal(title, message, onConfirm) {
        const modal = document.getElementById('confirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.style.display = 'flex';

        // Remove existing event listeners
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));

        // Add new event listeners
        document.getElementById('confirmBtn').addEventListener('click', () => {
          modal.style.display = 'none';
          onConfirm();
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
          modal.style.display = 'none';
        });
      }

      async function performRevokeAccess(userId) {
        try {
          const response = await fetch('/api/revoke-user-access', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: userId })
          });

          const result = await response.json();

          if (response.ok) {
            showNotification('User access revoked successfully!', 'success');
            // Update the role display
            const userCard = document.querySelector(`[data-user-id="${userId}"]`);
            const roleSpan = userCard.querySelector('.user-role');
            const roleSelect = document.getElementById(`role-${userId}`);
            roleSpan.textContent = 'viewer';
            roleSpan.className = 'user-role role-viewer';
            roleSelect.value = 'viewer';
            userCard.dataset.role = 'viewer';
          } else {
            showNotification('Error: ' + result.error, 'error');
          }
        } catch (error) {
          showNotification('Error revoking access: ' + error.message, 'error');
        }
      }

      async function performDeleteUser(userId) {
        try {
          const response = await fetch('/api/delete-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: userId })
          });

          const result = await response.json();

          if (response.ok) {
            showNotification('User deleted successfully!', 'success');
            // Remove the user card from the UI
            const userCard = document.querySelector(`[data-user-id="${userId}"]`);
            userCard.remove();
          } else {
            showNotification('Error: ' + result.error, 'error');
          }
        } catch (error) {
          showNotification('Error deleting user: ' + error.message, 'error');
        }
      }
    </script>
  </body>
</html>
